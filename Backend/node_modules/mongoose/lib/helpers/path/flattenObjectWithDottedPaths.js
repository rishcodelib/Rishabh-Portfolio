'use strict';

<<<<<<< HEAD
const setDottedPath = require('../path/setDottedPath');
=======
const MongooseError = require('../../error/mongooseError');
const setDottedPath = require('../path/setDottedPath');
const util = require('util');
>>>>>>> Frontend

/**
 * Given an object that may contain dotted paths, flatten the paths out.
 * For example: `flattenObjectWithDottedPaths({ a: { 'b.c': 42 } })` => `{ a: { b: { c: 42 } } }`
 */

module.exports = function flattenObjectWithDottedPaths(obj) {
  if (obj == null || typeof obj !== 'object' || Array.isArray(obj)) {
    return;
  }
<<<<<<< HEAD
=======
  // Avoid Mongoose docs
  if (obj.$__) {
    return;
  }
>>>>>>> Frontend
  const keys = Object.keys(obj);
  for (const key of keys) {
    const val = obj[key];
    if (key.indexOf('.') !== -1) {
<<<<<<< HEAD
      delete obj[key];
      setDottedPath(obj, key, val);
=======
      try {
        delete obj[key];
        setDottedPath(obj, key, val);
      } catch (err) {
        if (!(err instanceof TypeError)) {
          throw err;
        }
        throw new MongooseError(`Conflicting dotted paths when setting document path, key: "${key}", value: ${util.inspect(val)}`);
      }
>>>>>>> Frontend
      continue;
    }

    flattenObjectWithDottedPaths(obj[key]);
  }
};